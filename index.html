<!-- Full HTML file starts here -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>HealthCare+ ‚Äî Professional Demo</title>

<!-- Bootstrap & icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

<style>
:root{--brand:#0d6efd;--accent:#0ea5e9;--muted:#6b7280}
body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial; background:#f4f7fb; color:#0b2545}
.topbar{background:#fff; border-bottom:1px solid #e9eef5}
.hero{background:linear-gradient(90deg,var(--brand),#0b84ff); color:#fff; border-radius:12px; padding:36px}
.category-card{background:#fff; border-radius:12px; padding:18px; text-align:center; cursor:pointer}
.product-card{border-radius:12px; background:#fff; padding:12px; box-shadow:0 10px 30px rgba(2,6,23,.04)}
.product-card img{height:140px; width:100%; object-fit:cover; border-radius:8px}
.product-photo{height:110px; border-radius:10px; background:linear-gradient(135deg,#e0f2fe,#dbeafe)}
.footer{background:#041627; color:#a7c4db; padding:36px; margin-top:36px}
.vault-card{border:1px dashed #e2e8f0; border-radius:12px; padding:16px; background:#fff}
.category-card:hover{background:var(--brand); color:#fff; transform:translateY(-4px); transition:all .2s}
.product-card:hover{transform:translateY(-6px); transition:all .18s}
.carousel-banner img{object-fit:cover; height:360px; width:100%; border-radius:8px}
.feature-carousel .carousel-item{padding:24px}
/* Cart Sidebar */
.cart-sidebar{position:fixed; top:0; right:-420px; width:420px; max-width:100%; height:100vh; background:#fff; box-shadow:-6px 0 30px rgba(2,6,23,.12); display:flex; flex-direction:column; transition:right .35s ease; z-index:3000}
.cart-sidebar.active{right:0}
.cart-item-row{border-bottom:1px solid #eee; padding:12px 0}
.qty-btn{width:34px; height:34px; padding:0}
@media(max-width:576px){ .cart-sidebar{width:100%} .carousel-banner img{height:200px} }

/* small */
.small-muted{color:var(--muted); font-size:.9rem}

/* AI page (full page) */
.ai-page { display: none; padding: 18px 0; }
.ai-chat { height: 58vh; overflow-y: auto; padding: 12px; background: #f8fafc; border-radius: 8px; }
.ai-message { display:flex; gap:10px; margin-bottom:10px; align-items:flex-start; }
.ai-avatar { width:38px; height:38px; border-radius:50%; flex-shrink:0; background:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; color:#fff; }
.ai-avatar.bot { background:linear-gradient(135deg,#7c3aed,#06b6d4); }
.ai-avatar.user { background:var(--brand); }
.ai-bubble { padding:10px 12px; border-radius:12px; max-width:78%; box-shadow:0 4px 12px rgba(2,6,23,0.06); }
.ai-bubble.bot { background:#eef2ff; color:#07203a; }
.ai-bubble.user { background:var(--brand); color:#fff; margin-left:auto; text-align:right; }
.ai-meta { font-size:0.75rem; color:var(--muted); margin-top:4px; }

/* conversation list (in dashboard or per patient) */
.conv-list { max-height:50vh; overflow:auto; padding:8px; background:#fff; border-radius:8px; border:1px solid #eef2f7; }

/* Ask AI inline button */
.ask-ai-btn { font-size: .85rem; padding: .25rem .6rem; }

/* Reminders UI */
.reminder-item { display:flex; justify-content:space-between; align-items:center; padding:.5rem; border-radius:8px; border:1px solid #eef2f7; margin-bottom:.5rem; background:#fff; }

/* small tidy */
.illustration { width: 80px; height: 80px; border-radius: 50%; object-fit: cover; background: #f8f9fa; padding: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s ease; }
.product-card { border-radius: 1rem; background: #fff; transition: all 0.3s ease; }
.product-card:hover { transform: translateY(-4px); box-shadow: 0 8px 20px rgba(0,0,0,0.1); }

.nav-dashboard { display:flex; align-items:center; gap:6px; }
</style>
</head>
<body>

<!-- TOP NAV -->
<header class="topbar py-2">
  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between">
      <a href="#" id="home-link" class="d-flex align-items-center text-decoration-none">
        <img src="" alt="logo" style="width:44px;height:44px;border-radius:8px;background:linear-gradient(90deg,#60a5fa,#22d3ee)" class="me-2">
        <h4 class="mb-0">HealthCare+</h4>
      </a>

      <div class="d-flex align-items-center gap-2">
        <input id="global-search" class="form-control form-control-sm d-none d-md-block" placeholder="Search medicines, tests, doctors..."/>
        <button id="search-btn" class="btn btn-sm btn-outline-secondary d-none d-md-inline">Search</button>

        <!-- Dashboard always visible (3-lines icon + text) -->
        <button id="dashboard-nav" class="btn btn-outline-primary nav-dashboard">
          <i class="bi bi-list fs-5"></i>
          <span class="d-none d-sm-inline ms-1">Dashboard</span>
        </button>

        <button class="btn btn-outline-success" id="cart-btn"><i class="bi bi-cart"></i> Cart <span id="cart-count" class="badge bg-danger ms-2">0</span></button>
        <button class="btn btn-outline-primary" id="login-btn"><i class="bi bi-person-circle"></i> Login</button>

        <div id="user-info" class="d-none ms-2 align-items-center">
          <i class="bi bi-person-check text-success me-1"></i>
          <span id="user-name" class="me-2"></span>
          <button class="btn btn-sm btn-outline-danger" id="logout-btn">Logout</button>
        </div>
      </div>
    </div>
  </div>
</header>

<!-- FEATURE CAROUSEL -->
<div class="container my-5">
  <div id="featuredCarouselTop" class="carousel slide carousel-banner" data-bs-ride="carousel" data-bs-interval="4000">
    <div class="carousel-inner text-center">
      <div class="carousel-item active">
        <div class="p-5 rounded-4 text-white" style="background: linear-gradient(135deg, #007bff, #00aaff);">
          <div class="display-4 mb-3"><i class="bi bi-capsule"></i></div>
          <h3 class="fw-bold">Fast & Genuine Medicines</h3>
          <p class="lead">Top brands, verified supply and doorstep delivery.</p>
          <button class="btn btn-light text-primary btn-sm mt-2" data-goto="pharmacy">Shop Medicines</button>
        </div>
      </div>

      <div class="carousel-item">
        <div class="p-5 rounded-4 text-white" style="background: linear-gradient(135deg, #20c997, #2fd08a);">
          <div class="display-4 mb-3"><i class="bi bi-flask"></i></div>
          <h3 class="fw-bold">Trusted Lab Tests</h3>
          <p class="lead">Partner labs for accurate diagnostics & home sample pickup.</p>
          <button class="btn btn-light text-success btn-sm mt-2" data-goto="labs">Book a Test</button>
        </div>
      </div>

      <div class="carousel-item">
        <div class="p-5 rounded-4 text-white" style="background: linear-gradient(135deg, #6610f2, #8c52ff);">
          <div class="display-4 mb-3"><i class="bi bi-person-badge"></i></div>
          <h3 class="fw-bold">Consult Top Doctors</h3>
          <p class="lead">Video and chat consultations from verified specialists.</p>
          <button class="btn btn-light text-primary btn-sm mt-2" data-goto="consult">Consult Now</button>
        </div>
      </div>

      <div class="carousel-item">
        <div class="p-5 rounded-4 text-white" style="background: linear-gradient(135deg, #dc3545, #ff6b81);">
          <div class="display-4 mb-3"><i class="bi bi-shield-lock"></i></div>
          <h3 class="fw-bold">Secure Health Vault</h3>
          <p class="lead">Store prescriptions, reports, and health data safely and privately.</p>
          <button class="btn btn-light text-danger btn-sm mt-2" data-goto="vault">View Vault</button>
        </div>
      </div>
    </div>

    <button class="carousel-control-prev" type="button" data-bs-target="#featuredCarouselTop" data-bs-slide="prev">
      <span class="carousel-control-prev-icon"></span>
    </button>
    <button class="carousel-control-next" type="button" data-bs-target="#featuredCarouselTop" data-bs-slide="next">
      <span class="carousel-control-next-icon"></span>
    </button>
  </div>
</div>

<!-- MAIN HOME SECTION -->
<section class="container my-3 home-section">
  <div class="row g-4">
    <div class="col-lg-8">
      <div class="hero p-4">
        <h1 class="mb-2">Medicines, Tests & Consultations ‚Äî delivered fast</h1>
        <p class="mb-3">Order medicines, book lab tests, consult doctors, and store health records securely.</p>
        <div class="d-flex gap-2">
          <input id="hero-search" class="form-control form-control-lg search" placeholder="Search medicines, tests or doctors" />
          <button class="btn btn-lg btn-light text-primary" id="hero-search-btn">Search</button>
        </div>
      </div>

      <div class="my-4 feature-carousel">
        <div id="featureCarousel" class="carousel slide" data-bs-ride="carousel">
          <div class="carousel-inner bg-white rounded shadow-sm p-3">
            <div class="carousel-item active">
              <div class="row text-center">
                <div class="col-md-4">
                  <i class="bi bi-truck display-5 text-primary"></i>
                  <h5 class="mt-2">Fast Delivery</h5>
                </div>
                <div class="col-md-4">
                  <i class="bi bi-robot display-5 text-success"></i>
                  <h5 class="mt-2">AI Health Assistant</h5>
                </div>
                <div class="col-md-4">
                  <i class="bi bi-lock display-5 text-danger"></i>
                  <h5 class="mt-2">Secure Vault</h5>
                </div>
              </div>
            </div>
            <div class="carousel-item">
              <div class="row text-center">
                <div class="col-md-4">
                  <i class="bi bi-file-medical display-5 text-info"></i>
                  <h5 class="mt-2">Trusted Labs</h5>
                </div>
                <div class="col-md-4">
                  <i class="bi bi-people display-5 text-warning"></i>
                  <h5 class="mt-2">Verified Doctors</h5>
                </div>
                <div class="col-md-4">
                  <i class="bi bi-credit-card-2-back display-5 text-primary"></i>
                  <h5 class="mt-2">Easy Payments</h5>
                </div>
              </div>
            </div>
          </div>

          <button class="carousel-control-prev" type="button" data-bs-target="#featureCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
          <button class="carousel-control-next" type="button" data-bs-target="#featureCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
        </div>
      </div>

      <div class="row mt-1 g-3">
        <div class="col-3"><div class="category-card p-3" data-page="pharmacy"><i class="bi bi-capsule display-6 text-primary"></i><p class="mb-0 mt-2">Medicines</p></div></div>
        <div class="col-3"><div class="category-card p-3" data-page="labs"><i class="bi bi-beaker display-6 text-success"></i><p class="mb-0 mt-2">Lab Tests</p></div></div>
        <div class="col-3"><div class="category-card p-3" data-page="consult"><i class="bi bi-camera-video display-6 text-warning"></i><p class="mb-0 mt-2">Doctors</p></div></div>
        <div class="col-3"><div class="category-card p-3" data-page="vault"><i class="bi bi-briefcase-medical display-6 text-danger"></i><p class="mb-0 mt-2">Health Vault</p></div></div>
      </div>

      <h4 class="mt-4 d-flex align-items-center justify-content-between">
        <span>Trending Medicines</span>
        <button class="btn btn-sm btn-outline-secondary ask-ai-btn" id="ask-ai-global">üí¨ Ask AI</button>
      </h4>

      <div class="row g-3" id="product-grid"></div>
    </div>

    <aside class="col-lg-4">
      <div class="card p-3 mb-3">
        <h6>Health Vault</h6>
        <div class="vault-card text-center">
          <input type="file" id="vault-upload" class="form-control mb-2" accept="image/*,.pdf">
          <button class="btn btn-outline-primary" id="view-vault">View Vault</button>
        </div>
      </div>

      <div class="card p-3 mb-3">
        <h6>Need Help?</h6>
        <p class="mb-0">Call: <a href="tel:102">102</a> | <a href="#" id="live-chat">Live Chat</a></p>
      </div>
    </aside>
  </div>
</section>

<!-- PAGES -->
<main class="container mb-5">
  <section id="page-pharmacy" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>Shop Medicines</h3>
      <button class="btn btn-sm btn-outline-secondary ask-ai-btn" id="ask-ai-pharmacy">üí¨ Ask AI</button>
    </div>
    <div class="row g-3" id="shop-grid"></div>
    <nav><ul id="shop-pagination" class="pagination justify-content-center mt-3"></ul></nav>
  </section>

  <section id="page-labs" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>Lab Test Packages</h3>
      <button class="btn btn-sm btn-outline-secondary ask-ai-btn" id="ask-ai-labs">üí¨ Ask AI</button>
    </div>
    <div class="row g-3" id="lab-grid"></div>
    <nav><ul id="lab-pagination" class="pagination justify-content-center mt-3"></ul></nav>
  </section>

  <section id="page-consult" style="display:none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h3>Consult a Doctor</h3>
      <button class="btn btn-sm btn-outline-secondary ask-ai-btn" id="ask-ai-doctors">üí¨ Ask AI</button>
    </div>
    <div class="row g-3" id="doctor-grid"></div>
    <nav><ul id="doctor-pagination" class="pagination justify-content-center mt-3"></ul></nav>
  </section>

  <section id="page-vault" style="display:none">
    <h3>Your Health Vault</h3>
    <div id="vault-list" class="row g-3"></div>
  </section>

  <!-- AI PAGE (full page chat) -->
  <section id="page-ai" class="ai-page" style="display:none">
    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-start">
        <div>
          <h4 class="mb-1">Health Assistant</h4>
          <div id="ai-context" class="ai-context small-muted">Ask questions or upload an image for analysis.</div>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-secondary" id="ai-back">‚Üê Back</button>
        </div>
      </div>

      <div id="ai-chat" class="ai-chat mt-3"></div>

      <div class="mt-3 d-flex gap-2 align-items-center">
        <input id="ai-question" class="form-control" placeholder="Type your question..." />
        <label class="btn btn-outline-secondary mb-0">
          <i class="bi bi-upload"></i> <input id="ai-image" type="file" accept="image/*" style="display:none">
        </label>
        <button class="btn btn-success" id="ai-send">Send</button>
      </div>
      <div id="ai-file-preview" class="mt-2"></div>
    </div>
  </section>

  <!-- USER DASHBOARD (full page) -->
  <section id="user-dashboard" style="display:none">
    <div class="card p-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h3>Welcome, <span id="dashboard-name"></span> üëã</h3>
          <p class="mb-0 small-muted">Email: <span id="dashboard-email"></span></p>
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary" id="add-reminder-btn"><i class="bi bi-alarm"></i> Add Reminder</button>
        </div>
      </div>

      <div class="row mt-3">
        <div class="col-md-4">
          <h6>Orders</h6>
          <ul id="user-orders" class="list-group"></ul>
        </div>
        <div class="col-md-4">
          <h6>Doctor Bookings</h6>
          <ul id="user-doctors" class="list-group"></ul>
        </div>
        <div class="col-md-4">
          <h6>Lab Bookings</h6>
          <ul id="user-labs" class="list-group"></ul>
        </div>
      </div>

      <hr class="my-3">
      <div>
        <h6>Reminders</h6>
        <div id="reminder-list" class="mt-2"></div>
      </div>
    </div>
  </section>
</main>

<!-- CART SIDEBAR -->
<div id="cart-sidebar" class="cart-sidebar" aria-hidden="true">
  <div class="d-flex justify-content-between align-items-center p-3 border-bottom">
    <h5 class="mb-0">Your Cart</h5>
    <button class="btn btn-sm btn-outline-danger" id="close-cart"><i class="bi bi-x-lg"></i></button>
  </div>
  <div id="cart-items" class="p-3 flex-grow-1 overflow-auto"></div>
  <div class="p-3 border-top">
    <div class="d-flex justify-content-between mb-2">
      <div><small class="small-muted">Items</small><div id="cart-count-text"></div></div>
      <div><small class="small-muted">Subtotal</small><div><strong>‚Çπ<span id="cart-total">0</span></strong></div></div>
    </div>
    <div class="d-grid gap-2">
      <button class="btn btn-success" id="checkout-btn">Checkout</button>
      <button class="btn btn-outline-secondary" id="clear-cart">Clear Cart</button>
    </div>
  </div>
</div>

<!-- AUTH MODAL -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content rounded-4 shadow">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Login / Sign Up</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- LOGIN -->
        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="loginEmail" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="loginPassword" class="form-control" required>
          </div>
          <button class="btn btn-primary w-100 mb-2" type="submit">Login</button>
        </form>

        <!-- SIGNUP -->
        <form id="signupForm" style="display:none;">
          <div class="mb-3">
            <label class="form-label">Name</label>
            <input type="text" id="signupName" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="signupEmail" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password" id="signupPassword" class="form-control" required>
          </div>
          <button class="btn btn-success w-100 mb-2" type="submit">Sign Up</button>
        </form>

        <p class="text-center mt-3">
          <a href="#" id="toggleAuth">Don't have an account? Sign up</a>
        </p>
      </div>
    </div>
  </div>
</div>

<!-- REMINDER MODAL (small) -->
<div class="modal fade" id="reminderModal" tabindex="-1">
  <div class="modal-dialog modal-sm">
    <div class="modal-content rounded-3">
      <div class="modal-header">
        <h6 class="modal-title">Add Reminder</h6>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Title</label>
          <input id="reminder-title" class="form-control" placeholder="e.g., Take medicine" />
        </div>
        <div class="mb-2">
          <label class="form-label">Time</label>
          <input id="reminder-time" type="time" class="form-control" />
        </div>
        <div class="mb-2">
          <label class="form-label">Repeat</label>
          <select id="reminder-repeat" class="form-control">
            <option value="once">Once</option>
            <option value="daily">Daily</option>
          </select>
        </div>
        <div class="d-grid">
          <button class="btn btn-primary" id="save-reminder">Save Reminder</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer class="footer">
  <div class="container">
    <div class="row">
      <div class="col-md-4"><h5>HealthCare+</h5><p>Demo clone for learning & prototyping.</p></div>
      <div class="col-md-4"><h6>Services</h6><ul class="list-unstyled"><li>Order Medicines</li><li>Book Lab Tests</li><li>Consult Doctors</li></ul></div>
      <div class="col-md-4"><h6>Contact</h6><p>support@healthcare.demo</p></div>
    </div>
  </div>
</footer>

<!-- Audio for notification -->
<audio id="notif-audio" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABAAZGF0YQAAAAA="></audio>
<!-- Above is a tiny empty WAV placeholder (short click). Replace src with your beep if you want a nicer sound. -->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ---------- CONFIG ---------- */
const API_BASE = 'https://shyam-backend.onrender.com/api';
let products = [], labs = [], doctors = [], cart = JSON.parse(localStorage.getItem('cart') || '[]');

/* helpers */
function el(id){ return document.getElementById(id); }
function nowISO(){ return new Date().toISOString(); }
function timestamp(){ const d=new Date(); return d.toLocaleString(); }

/* ---------- PAGINATION & RENDER HELPERS (kept similar) ---------- */
function paginate(array, perPage, page) {
  const start = (page - 1) * perPage; return array.slice(start, start + perPage);
}

/* ---------- RENDERING ---------- */
function renderTrending() {
  const elGrid = el('product-grid'); elGrid.innerHTML = '';
  (products.slice(0,8)).forEach(p => {
    const col = document.createElement('div'); col.className = 'col-md-3 col-6';
    col.innerHTML = `
      <div class='product-card p-3 text-center shadow-sm'>
        <div class="illustration text-primary fs-1 mb-2"><i class="bi bi-capsule"></i></div>
        <h6 class="text-truncate mt-2">${p.name}</h6>
        <small class="text-muted">${p.brand || ''}</small>
        <div class='d-flex justify-content-between align-items-center mt-2'>
          <strong>‚Çπ${p.price || 0}</strong>
          <div>
            <button class='btn btn-sm btn-success me-1' data-add='${p._id}'>Add</button>
            <button class='btn btn-sm btn-outline-primary ask-ai-inline' data-context='product:${encodeURIComponent(p.name)}'>Ask AI</button>
          </div>
        </div>
      </div>`;
    elGrid.appendChild(col);
  });
}

function renderShop(page = 1){
  const perPage = 9; const items = paginate(products, perPage, page); const grid = el('shop-grid'); grid.innerHTML = '';
  items.forEach(p=>{
    const col = document.createElement('div'); col.className='col-md-4 col-sm-6 mb-4';
    col.innerHTML = `
      <div class="product-card p-3 text-center shadow-sm rounded-4 border">
        <div class="illustration text-success fs-1 mb-2"><i class="bi bi-capsule"></i></div>
        <h5 class="mt-2 text-primary">${p.name}</h5>
        <p class="text-muted mb-2">${p.brand||''}</p>
        <div class="d-flex justify-content-between align-items-center mt-3">
          <strong>‚Çπ${p.price||0}</strong>
          <div>
            <button class="btn btn-sm btn-success rounded-pill px-3" data-add="${p._id}">Add</button>
            <button class="btn btn-sm btn-outline-primary ask-ai-inline" data-context='product:${encodeURIComponent(p.name)}'>Ask AI</button>
          </div>
        </div>
      </div>`;
    grid.appendChild(col);
  });

  // pagination simple
  const totalPages = Math.max(1, Math.ceil(products.length / perPage));
  const pg = el('shop-pagination'); if(pg){ pg.innerHTML=''; for(let i=1;i<=totalPages;i++){ const li=document.createElement('li'); li.className='page-item ' + (i===1?'active':''); const a=document.createElement('a'); a.href='#'; a.className='page-link'; a.textContent=i; a.onclick=(e)=>{ e.preventDefault(); renderShop(Number(a.textContent)); }; li.appendChild(a); pg.appendChild(li); } }
}

/* ---------- LABS SECTION RENDER ---------- */
function renderLabs() {
  const grid = document.getElementById('lab-grid');
  grid.innerHTML = '';

  labs.forEach(l => {
    const query = encodeURIComponent(l.name || "lab test"); // safely encode for URL
    const col = document.createElement('div');
    col.className = 'col-md-4 mb-4';

    col.innerHTML = `
      <div class='product-card p-3 text-center shadow-sm rounded-4'>
        <div class="illustration text-info fs-1 mb-2">
          <i class="fa-solid fa-flask"></i>
        </div>
        <h6 class="mt-2 fw-semibold">${l.name}</h6>
        <p class="text-muted mb-2">${l.specialty || 'Diagnostic Center'}</p>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <strong>‚Çπ${l.price || 0}</strong>
          <div class="d-flex gap-1">
            <button class='btn btn-sm btn-primary' data-book='${l._id}'>Book</button>
            <button class='btn btn-sm btn-outline-success' onclick="window.open('https://www.google.com/maps/search/${query}+near+me','_blank')">Find Nearby</button>
          </div>
        </div>
      </div>
    `;

    grid.appendChild(col);
  });
}

/* ---------- DOCTORS SECTION RENDER ---------- */
function renderDoctors() {
  const grid = document.getElementById('doctor-grid');
  grid.innerHTML = '';

  doctors.forEach(d => {
    const col = document.createElement('div');
    col.className = 'col-md-3 col-6';
    col.innerHTML = `
      <div class='product-card p-3 text-center shadow-sm rounded-4'>
        <div class="illustration text-primary fs-1 mb-2">
          <i class="fa-solid fa-user-doctor"></i>
        </div>
        <h6 class="mt-2 fw-semibold">${d.name}</h6>
        <p class="text-muted mb-1">${d.spec || ''} ‚Ä¢ ‚≠ê ${d.rating || 'N/A'}</p>
        <div class="d-flex justify-content-between align-items-center mt-2">
          <span class="text-muted">‚Çπ${d.fee || 0}</span>
          <div class="d-flex gap-1">
            <button class='btn btn-sm btn-primary' data-consult='${d._id}'>Consult</button>
            <button class='btn btn-sm btn-outline-primary ask-ai-inline' data-context='doctor:${encodeURIComponent(d.name)}'>Ask AI</button>
          </div>
        </div>
      </div>`;
    grid.appendChild(col);
  });
}
/* ---------- CART ---------- */
function updateCartUI(){
  const itemsContainer = el('cart-items'); itemsContainer.innerHTML = ''; let total=0;
  if(!cart.length){ itemsContainer.innerHTML = '<div class="text-center text-muted py-4">Your cart is empty</div>'; }
  else {
    cart.forEach(it=>{
      total += it.qty * it.price;
      const row = document.createElement('div'); row.className='cart-item-row d-flex align-items-center';
      row.innerHTML = `
        <div style="flex:1"><div class="fw-semibold">${it.name}</div><div class="small-muted">‚Çπ${it.price} each</div></div>
        <div class="d-flex align-items-center gap-2 me-2">
          <button class="btn btn-outline-secondary qty-btn" data-decrease="${it._id}">‚àí</button>
          <div style="min-width:28px; text-align:center">${it.qty}</div>
          <button class="btn btn-outline-secondary qty-btn" data-increase="${it._id}">+</button>
        </div>
        <div style="text-align:right"><div>‚Çπ${it.price * it.qty}</div><button class="btn btn-sm btn-link text-danger p-0 mt-1" data-remove="${it._id}">Remove</button></div>`;
      itemsContainer.appendChild(row);
    });
  }
  el('cart-total').textContent = total;
  el('cart-count').textContent = cart.reduce((s,i)=>s+i.qty,0) || 0;
  el('cart-count-text').textContent = cart.reduce((s,i)=>s+i.qty,0) || 0;
  localStorage.setItem('cart', JSON.stringify(cart));
}

/* ---------- FETCH from backend ---------- */
async function fetchProducts(){ try{ const r=await fetch(`${API_BASE}/products`); products = await r.json(); renderTrending(); renderShop(1); updateCartUI(); }catch(e){ console.warn('fetchProducts failed',e); } }
async function fetchLabs(){ try{ const r=await fetch(`${API_BASE}/labs`); labs = await r.json(); renderLabs(1); }catch(e){ console.warn('fetchLabs failed',e); } }
async function fetchDoctors(){ try{ const r=await fetch(`${API_BASE}/doctors`); doctors = await r.json(); renderDoctors(1); }catch(e){ console.warn('fetchDoctors failed',e); } }

/* ---------- NAV & UI HANDLERS ---------- */
document.getElementById('cart-btn').addEventListener('click', ()=> document.getElementById('cart-sidebar').classList.add('active'));
document.getElementById('close-cart').addEventListener('click', ()=> document.getElementById('cart-sidebar').classList.remove('active'));
document.getElementById('clear-cart').addEventListener('click', ()=>{ if(!cart.length) return alert('Cart already empty'); if(!confirm('Clear all items?')) return; cart=[]; updateCartUI(); });
document.getElementById('checkout-btn').addEventListener('click', ()=>{ if(!cart.length) return alert('Cart is empty'); alert('Checkout placeholder ‚Äî integrate payments.'); cart=[]; updateCartUI(); });

document.body.addEventListener('click', (e)=>{
  const add = e.target.dataset.add;
  const book = e.target.dataset.book;
  const consult = e.target.dataset.consult;
  const inc = e.target.dataset.increase;
  const dec = e.target.dataset.decrease;
  const rem = e.target.dataset.remove;

  if(add){ const p = products.find(x=>x._id==add); if(!p) return; const ex = cart.find(c=>c._id==p._id); if(ex) ex.qty++; else cart.push({_id:p._id, name:p.name, price:p.price, qty:1}); updateCartUI(); showToast(`${p.name} added to cart`); return; }
  if(book){ const l = labs.find(x=>x._id==book); if(l) alert('Booked test: '+l.name); return; }
  if(consult){ const d = doctors.find(x=>x._id==consult); if(d) alert('Consult request: '+d.name); return; }
  if(inc){ const item = cart.find(i=>i._id==inc); if(item) item.qty++; updateCartUI(); return; }
  if(dec){ const item = cart.find(i=>i._id==dec); if(item){ if(item.qty>1) item.qty--; else cart = cart.filter(x=>x._id!=dec); updateCartUI(); } return; }
  if(rem){ if(!confirm('Remove item?')) return; cart = cart.filter(x=>x._id!=rem); updateCartUI(); return; }

  // inline ask-ai handler
  const askBtn = e.target.closest('.ask-ai-inline');
  if(askBtn){
    const ctx = askBtn.dataset.context || '';
    const decoded = ctx ? decodeURIComponent(ctx.replace(/^.+?:/,'')) : '';
    openAiPage(decoded, ctx || 'General');
  }
});

/* ---------- NAV PAGES ---------- */
function goToPage(page){
  // hide all main sections and show requested
  document.querySelectorAll('main > section, section.home-section').forEach(s=>s.style.display='none');
  if(page === 'home'){ document.querySelector('.home-section').style.display='block'; return; }
  const elPage = document.getElementById('page-' + page);
  if(elPage) elPage.style.display = 'block';
  window.scrollTo(0,0);
}
document.getElementById('home-link').addEventListener('click',(e)=>{ e.preventDefault(); goToPage('home'); });
document.querySelectorAll('[data-goto], .category-card').forEach(el => 
  el.addEventListener('click', (ev) => {
    const target = ev.currentTarget; // always the box itself
    const page = target.dataset.goto || target.dataset.page;
    if (page) goToPage(page);
  })
);
document.getElementById('hero-search-btn').addEventListener('click', ()=> doSearch(document.getElementById('hero-search').value));
document.getElementById('search-btn').addEventListener('click', ()=> doSearch(document.getElementById('global-search').value));
document.getElementById('global-search').addEventListener('keydown', (e)=>{ if(e.key==='Enter') doSearch(e.target.value); });

function doSearch(q){
  if(!q) return; q = q.toLowerCase();
  let found = products.find(p => (p.name||'').toLowerCase().includes(q));
  if(found){ goToPage('pharmacy'); renderShop(1); return; }
  found = labs.find(l => (l.name||'').toLowerCase().includes(q));
  if(found){ goToPage('labs'); renderLabs(1); return; }
  found = doctors.find(d => (d.name||'').toLowerCase().includes(q));
  if(found){ goToPage('consult'); renderDoctors(1); return; }
  window.open('https://www.google.com/search?q='+encodeURIComponent(q), '_blank');
}

/* ---------- VAULT ---------- */
function renderVault(){
  const vault = el('vault-list'); vault.innerHTML='';
  const arr = JSON.parse(localStorage.getItem('vault') || '[]');
  arr.forEach(f=>{
    const col = document.createElement('div'); col.className='col-md-4';
    col.innerHTML = `<div class="product-card p-3"><p class="mb-2">${f.name}</p><a href="${f.url}" target="_blank" class="btn btn-sm btn-primary">View</a></div>`;
    vault.appendChild(col);
  });
}
el('vault-upload').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{ const arr=JSON.parse(localStorage.getItem('vault')||'[]'); arr.push({name:f.name,time:Date.now(),url:reader.result}); localStorage.setItem('vault',JSON.stringify(arr)); renderVault(); showToast('Uploaded to vault'); };
  reader.readAsDataURL(f);
});
el('view-vault').addEventListener('click', ()=> goToPage('vault'));

/* ---------- TOAST ---------- */
function showToast(text){
  const t=document.createElement('div'); t.className='position-fixed bottom-0 end-0 m-3 p-2 rounded shadow bg-success text-white'; t.style.zIndex=5000; t.textContent=text; document.body.appendChild(t); setTimeout(()=>t.remove(),2000);
}

/* ---------- AUTH ---------- */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
let currentUser = JSON.parse(localStorage.getItem('user') || 'null');

function updateAuthUI(){
  if(currentUser){
    el('login-btn').classList.add('d-none');
    document.getElementById('user-info').classList.remove('d-none');
    el('user-name').textContent = currentUser.name || currentUser.username || '';
    // show dashboard content (do not auto-navigate)
  } else {
    el('login-btn').classList.remove('d-none');
    document.getElementById('user-info').classList.add('d-none');
  }
}
document.getElementById('login-btn').addEventListener('click', ()=> authModal.show());
document.getElementById('toggleAuth').addEventListener('click', (e)=>{ e.preventDefault(); const loginForm = document.getElementById('loginForm'); const signupForm = document.getElementById('signupForm'); if(loginForm.style.display==='none'){ loginForm.style.display='block'; signupForm.style.display='none'; document.getElementById('toggleAuth').textContent="Don't have an account? Sign up"; } else { loginForm.style.display='none'; signupForm.style.display='block'; document.getElementById('toggleAuth').textContent="Already have an account? Login"; } });

document.getElementById('loginForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const email = el('loginEmail').value, password = el('loginPassword').value;
  try{
    const res = await fetch(`${API_BASE}/auth/login`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ email, password }) });
    const data = await res.json();
    // adapt to your backend response shape
    if(data.success || data.token || data.user){
      // prefer data.user or construct from response
      if(data.user) currentUser = data.user;
      else if(data.success && data.user) currentUser = data.user;
      else if(data.token && data.user) currentUser = data.user;
      else currentUser = { name: data.name || data.user?.name || email, _id: data.user?.id || data.user?._id || (data.user && data.user.id) || data.id || data.userId };
      localStorage.setItem('user', JSON.stringify(currentUser));
      authModal.hide();
      updateAuthUI();
      showToast('Welcome ' + (currentUser.name || ''));
    } else {
      alert(data.message || 'Login failed');
    }
  }catch(err){ console.error(err); alert('Server error'); }
});

document.getElementById('signupForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const name = el('signupName').value, email = el('signupEmail').value, password = el('signupPassword').value;
  try{
    const res = await fetch(`${API_BASE}/auth/signup`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, email, password }) });
    const data = await res.json();
    if(data.success || data.message){
      alert(data.message || 'Signup successful ‚Äî please login');
      document.getElementById('loginForm').style.display='block'; document.getElementById('signupForm').style.display='none';
    } else alert(data.message || 'Signup failed');
  }catch(err){ console.error(err); alert('Server error'); }
});

document.getElementById('logout-btn').addEventListener('click', ()=>{
  localStorage.removeItem('user'); currentUser=null; updateAuthUI(); showToast('Logged out');
  goToPage('home');
});

/* Dashboard navigation (permanent button) */
document.getElementById('dashboard-nav').addEventListener('click', ()=> {
  if(!currentUser){
    // show login modal but still allow access to a demo dashboard? we'll show modal
    authModal.show();
    return;
  }
  goToDashboard();
});

/* fetch and render user-specific data into dashboard */
async function goToDashboard(){
  // show user dashboard page
  document.querySelectorAll('main > section, section.home-section').forEach(s=>s.style.display='none');
  el('user-dashboard').style.display='block';
  if(!currentUser) return;
  el('dashboard-name').textContent = currentUser.name || '';
  el('dashboard-email').textContent = currentUser.email || '';

  // Example endpoints (adapt to your backend)
  try {
    // Orders
    const or = await fetch(`${API_BASE}/orders/user/${currentUser._id}`).then(r=>r.json()).catch(()=>[]);
    const ulO = el('user-orders'); ulO.innerHTML='';
    if(Array.isArray(or) && or.length){
      or.forEach(o=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent = `${o.items?.length||0} items ‚Äî ‚Çπ${o.total||o.amount||0}`; ulO.appendChild(li); });
    } else ulO.innerHTML='<li class="list-group-item small-muted">No orders</li>';

    // Doctor bookings
    const bd = await fetch(`${API_BASE}/bookings/doctors/${currentUser._id}`).then(r=>r.json()).catch(()=>[]);
    const ulD = el('user-doctors'); ulD.innerHTML='';
    if(Array.isArray(bd) && bd.length){
      bd.forEach(b=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent = `${b.doctorName||b.name} ‚Äî ${b.date||b.time||'N/A'}`; ulD.appendChild(li); });
    } else ulD.innerHTML='<li class="list-group-item small-muted">No bookings</li>';

    // Lab bookings
    const bl = await fetch(`${API_BASE}/bookings/labs/${currentUser._id}`).then(r=>r.json()).catch(()=>[]);
    const ulL = el('user-labs'); ulL.innerHTML='';
    if(Array.isArray(bl) && bl.length){
      bl.forEach(b=>{ const li=document.createElement('li'); li.className='list-group-item'; li.textContent = `${b.testName||b.name} ‚Äî ${b.date||b.time||'N/A'}`; ulL.appendChild(li); });
    } else ulL.innerHTML='<li class="list-group-item small-muted">No lab bookings</li>';

  } catch(err){ console.warn('dashboard fetch error', err); }
  // also render reminders list
  renderReminders();
}

/* ---------- AI Chat Page + Persistence ---------- */
const aiChatEl = el('ai-chat');
const aiInput = el('ai-question');
const aiImageInput = el('ai-image');
const aiFilePreview = el('ai-file-preview');
let aiCurrentContext = '';
let currentConversationId = null; // user._id or 'guest'
const notifAudio = el('notif-audio');

document.getElementById('ai-back').addEventListener('click', ()=> goToPage('home'));
el('ai-send').addEventListener('click', sendAiQuestion);
aiImageInput.addEventListener('change', (e)=>{
  const f = e.target.files[0]; aiFilePreview.innerHTML='';
  if(!f) return;
  const img = document.createElement('img'); img.className='file-preview'; img.style.maxWidth='100%'; img.src = URL.createObjectURL(f); aiFilePreview.appendChild(img);
});

document.getElementById('ask-ai-global').addEventListener('click', ()=> openAiPage('', 'General'));
document.getElementById('ask-ai-pharmacy').addEventListener('click', ()=> openAiPage('', 'Pharmacy'));
document.getElementById('ask-ai-labs').addEventListener('click', ()=> openAiPage('', 'Labs'));
document.getElementById('ask-ai-doctors').addEventListener('click', ()=> openAiPage('', 'Doctors'));

function openAiPage(prefill='', rawContext=''){
  // set conversation id (user or guest)
  currentConversationId = currentUser?. _id || currentUser?.id || localStorage.getItem('user') ? (currentUser._id || currentUser.id) : 'guest';
  document.querySelectorAll('main > section, section.home-section').forEach(s=>s.style.display='none');
  el('page-ai').style.display='block';

  aiCurrentContext = rawContext || '';
  el('ai-context').textContent = aiCurrentContext ? `Context: ${aiCurrentContext}` : 'Ask questions or upload an image for analysis.';
  if(prefill) aiInput.value = prefill;
  loadConversation(currentConversationId);
  aiChatEl.scrollTop = aiChatEl.scrollHeight;
}

function saveConversation(convId, messages){
  const all = JSON.parse(localStorage.getItem('ai_conversations') || '{}');
  all[convId] = messages;
  localStorage.setItem('ai_conversations', JSON.stringify(all));
}

function loadConversation(convId){
  aiChatEl.innerHTML = '';
  const all = JSON.parse(localStorage.getItem('ai_conversations') || '{}');
  const messages = all[convId] || [];
  messages.forEach(msg=>{
    renderMessageToChat(msg);
  });
  aiChatEl.scrollTop = aiChatEl.scrollHeight;
}

function appendMessageToMemory(convId, message){
  const all = JSON.parse(localStorage.getItem('ai_conversations') || '{}');
  if(!all[convId]) all[convId] = [];
  all[convId].push(message);
  localStorage.setItem('ai_conversations', JSON.stringify(all));
}

/* render single message object {who:'bot'|'user', text:'', time:'ISO', fileUrl?: ''} */
function renderMessageToChat(msg){
  const container = document.createElement('div'); container.className = 'ai-message';
  const isUser = msg.who === 'user';
  // avatar
  const avatar = document.createElement('div'); avatar.className = 'ai-avatar ' + (isUser ? 'user' : 'bot');
  avatar.textContent = isUser ? ( (currentUser && currentUser.name ? (currentUser.name[0]||'U') : 'U') ) : 'AI';
  // bubble + meta
  const bubble = document.createElement('div'); bubble.className = 'ai-bubble ' + (isUser ? 'user' : 'bot'); bubble.innerText = msg.text || '';
  const meta = document.createElement('div'); meta.className = 'ai-meta'; meta.innerText = msg.time ? new Date(msg.time).toLocaleString() : timestamp();

  if(isUser){
    // user message aligns right
    container.style.justifyContent = 'flex-end';
    container.appendChild(bubble);
    container.appendChild(avatar);
    container.appendChild(meta);
  } else {
    container.appendChild(avatar);
    container.appendChild(bubble);
    container.appendChild(meta);
  }

  // file preview
  if(msg.fileUrl){
    const fdiv = document.createElement('div'); fdiv.style.marginTop='8px';
    if(msg.fileType && msg.fileType.startsWith('image')){
      const img = document.createElement('img'); img.src = msg.fileUrl; img.style.maxWidth='200px'; img.style.borderRadius='8px'; fdiv.appendChild(img);
    } else {
      const a = document.createElement('a'); a.href=msg.fileUrl; a.target='_blank'; a.textContent = 'View file'; fdiv.appendChild(a);
    }
    bubble.appendChild(fdiv);
  }

  aiChatEl.appendChild(container);
}

/* send question to backend (text or image) */
async function sendAiQuestion(){
  const q = aiInput.value.trim();
  const file = aiImageInput.files[0];
  if(!q && !file) return alert('Type a question or attach an image.');

  // build message objects and persist
  const userMsg = { who:'user', text: q || (file ? 'Image: ' + (file.name || '') : ''), time: new Date().toISOString(), fileUrl: null, fileType: file ? file.type : null };
  renderMessageToChat(userMsg);
  appendMessageToMemory(currentConversationId, userMsg);

  // prepare request to backend
  try {
    if(file){
      const fd = new FormData(); fd.append('question', q); fd.append('context', aiCurrentContext); fd.append('image', file);
      const res = await fetch(`${API_BASE}/ai`, { method:'POST', body: fd });
      const data = await res.json();
      const botText = data.answer || data.result || 'No answer';
      const botMsg = { who:'bot', text: botText, time: new Date().toISOString(), fileUrl: data.fileUrl || null, fileType: data.fileType || null };
      renderMessageToChat(botMsg); appendMessageToMemory(currentConversationId, botMsg);
      notifyUser();
    } else {
      const res = await fetch(`${API_BASE}/ai`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ question: q, context: aiCurrentContext }) });
      const data = await res.json();
      const botText = data.answer || data.result || 'No answer';
      const botMsg = { who:'bot', text: botText, time: new Date().toISOString() };
      renderMessageToChat(botMsg); appendMessageToMemory(currentConversationId, botMsg);
      notifyUser();
    }
  } catch(err){
    console.error('AI request failed', err);
    const botMsg = { who:'bot', text: '‚ö†Ô∏è Error connecting to AI backend.', time: new Date().toISOString() };
    renderMessageToChat(botMsg); appendMessageToMemory(currentConversationId, botMsg);
  } finally {
    aiInput.value = ''; aiImageInput.value = ''; aiFilePreview.innerHTML = '';
    aiChatEl.scrollTop = aiChatEl.scrollHeight;
  }
}

/* Notification: play sound + vibrate */
function notifyUser(){
  try{
    // play a short beep
    notifAudio.currentTime = 0; notifAudio.play().catch(()=>{});
    // vibrate if supported
    if(navigator.vibrate) navigator.vibrate([100,50,100]);
  }catch(e){ /* ignore */ }
}

/* ---------- Conversation list improvements (not fully built but ready) ---------- */
/* Could be extended to list conversations/patients. For now we persist per user id or guest. */

/* ---------- Reminders (dashboard) ---------- */
const reminderModal = new bootstrap.Modal(document.getElementById('reminderModal'));
el('add-reminder-btn').addEventListener('click', ()=> reminderModal.show());
el('save-reminder').addEventListener('click', saveReminder);

function loadReminders(){
  const key = 'reminders_' + (currentUser? (currentUser._id || currentUser.id) : 'guest');
  return JSON.parse(localStorage.getItem(key) || '[]');
}

function saveRemindersList(list){
  const key = 'reminders_' + (currentUser? (currentUser._id || currentUser.id) : 'guest');
  localStorage.setItem(key, JSON.stringify(list));
}

function renderReminders(){
  const list = loadReminders();
  const container = el('reminder-list'); container.innerHTML = '';
  if(!list.length) container.innerHTML = '<div class="small-muted">No reminders</div>';
  list.forEach((r, idx)=>{
    const div = document.createElement('div'); div.className='reminder-item';
    div.innerHTML = `<div><strong>${r.title}</strong><div class="small-muted">${r.time} ‚Äî ${r.repeat}</div></div>
                     <div>
                       <button class="btn btn-sm btn-outline-danger me-1" data-reminder-remove="${idx}">Delete</button>
                       <button class="btn btn-sm btn-outline-secondary" data-reminder-test="${idx}">Test</button>
                     </div>`;
    container.appendChild(div);
  });
}

document.body.addEventListener('click', (e)=>{
  const remDel = e.target.dataset.reminderRemove;
  const remTest = e.target.dataset.reminderTest;
  if(remDel !== undefined){
    const idx = Number(remDel);
    const list = loadReminders(); list.splice(idx,1); saveRemindersList(list); renderReminders();
  } else if(remTest !== undefined){
    notifyUser(); alert('Reminder test: ' + (loadReminders()[Number(remTest)].title || 'Reminder'));
  }
});

function saveReminder(){
  const title = el('reminder-title').value.trim();
  const time = el('reminder-time').value;
  const repeat = el('reminder-repeat').value;
  if(!title || !time) return alert('Provide title and time');

  const list = loadReminders();
  list.push({ title, time, repeat, created: new Date().toISOString() });
  saveRemindersList(list);
  reminderModal.hide();
  el('reminder-title').value=''; el('reminder-time').value=''; el('reminder-repeat').value='once';
  renderReminders();
  scheduleReminders(); // refresh schedulers
}

/* schedule reminders to fire when the page is open (simple) */
let reminderTimers = [];
function clearReminderTimers(){ reminderTimers.forEach(t=>clearTimeout(t)); reminderTimers = []; }

function scheduleReminders(){
  clearReminderTimers();
  const list = loadReminders();
  list.forEach((r, idx)=>{
    const [hh, mm] = r.time.split(':').map(Number);
    if(isNaN(hh) || isNaN(mm)) return;
    const now = new Date();
    const run = new Date(now.getFullYear(), now.getMonth(), now.getDate(), hh, mm, 0, 0);
    if(run < now) {
      if(r.repeat === 'daily') run.setDate(run.getDate() + 1);
      else {
        // if once and time passed, do not schedule
        return;
      }
    }
    const ms = run.getTime() - now.getTime();
    const timer = setTimeout(()=> {
      // show notification (simple)
      notifyUser();
      alert('‚è∞ Reminder: ' + r.title + ' (' + r.time + ')');
      // if repeating daily, reschedule for next day
      if(r.repeat === 'daily'){
        // schedule next in 24h
        const nextTimer = setTimeout(()=>{ /* handled by next page load or reschedule */ }, 24*3600*1000);
        reminderTimers.push(nextTimer);
      }
    }, ms);
    reminderTimers.push(timer);
  });
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', ()=>{
  goToPage('home');
  fetchProducts(); fetchLabs(); fetchDoctors(); renderVault(); updateCartUI();
  updateAuthUI();
  scheduleReminders();

  // ensure inline 'Ask AI' delegation (buttons may be dynamic)
  document.body.addEventListener('click', (e)=>{ if(e.target && e.target.matches && e.target.matches('.ask-ai-btn')) openAiPage('', 'General'); });
});

/* ---------- small utils ---------- */
function elid(s){ return document.getElementById(s); }
</script>
</body>
</html>

